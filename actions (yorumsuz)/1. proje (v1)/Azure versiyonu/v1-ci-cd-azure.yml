
trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  DOTNET_VERSION: '10.0.x'
  SOLUTION_PATH: 'V1.sln'
  PROJECT_PATH: 'V1.Web/V1.Web.csproj'
  PUBLISH_DIR: '$(Build.ArtifactStagingDirectory)/v1-publish'
  AZURE_SERVICE_CONNECTION: '$(V1_AZURE_SERVICE_CONNECTION)'
  AZURE_WEBAPP_NAME: '$(V1_AZURE_WEBAPP_NAME)'

jobs:
- job: ci
  displayName: CI (Build, Test, Publish)
  pool:
    vmImage: ubuntu-latest
  steps:
  - checkout: self

  - task: UseDotNet@2
    inputs:
      version: '$(DOTNET_VERSION)'

  - script: dotnet restore $(SOLUTION_PATH)
    displayName: Restore

  - script: dotnet build $(SOLUTION_PATH) -c Release --no-restore
    displayName: Build

  - script: dotnet test $(SOLUTION_PATH) -c Release --no-build --verbosity normal
    displayName: Test

  - script: dotnet publish $(PROJECT_PATH) -c Release -o $(PUBLISH_DIR) --no-build
    displayName: Publish

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(PUBLISH_DIR)'
      ArtifactName: 'v1-webapp-publish'
      publishLocation: 'Container'

- job: cd
  displayName: CD (Deploy to Azure App Service)
  dependsOn: ci
  condition: succeeded()
  pool:
    vmImage: ubuntu-latest
  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      buildType: current
      downloadType: single
      artifactName: v1-webapp-publish
      downloadPath: '$(Pipeline.Workspace)'

  - task: AzureWebApp@1
    inputs:
      azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
      appType: webApp
      appName: '$(AZURE_WEBAPP_NAME)'
      package: '$(Pipeline.Workspace)/v1-webapp-publish'
